const { GoogleGenerativeAI } = require('@google/generative-ai');

class ProjectAnalyzer {
  constructor() {
    if (!process.env.GEMINI_API_KEY) {
      throw new Error('GEMINI_API_KEY is not set in environment variables.');
    }
    this.gemini = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
  }

  async analyzeText(text) {
    try {
      const systemPrompt = `
ã‚ãªãŸã¯ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒ»äº‹æ¥­éƒ¨é•·å‘ã‘ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚’è§£é‡ˆã—ã€Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç™»éŒ²ã™ã‚‹ãŸã‚ã®JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

# æŒ‡ç¤º
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ¨æ¸¬ã—ã¦è¨­å®šã—ã¦ãã ã•ã„ã€‚
- **é‡è¦**: ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æ˜ç¢ºã«èª­ã¿å–ã‚Œãªã„é …ç›®ã¯ã€ç„¡ç†ã«æ¨æ¸¬ã›ãšã«nullã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
- ãƒ†ã‚­ã‚¹ãƒˆãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚„è¤‡æ•°ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å«ã‚€ã‚¿ã‚¹ã‚¯ã®å ´åˆã€å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ã‚’WBSï¼ˆä½œæ¥­åˆ†è§£æ§‹æˆå›³ï¼‰ã¨ã—ã¦ç®‡æ¡æ›¸ãã§ç”Ÿæˆã—ã€pageContentã«æ ¼ç´ã—ã¦ãã ã•ã„ã€‚
- ãƒ†ã‚­ã‚¹ãƒˆãŒå˜ç´”ãªãƒ¡ãƒ¢ã‚„å˜ä¸€ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã¯ã€pageContentã«ã¯ãã®å†…å®¹ã‚’ç°¡æ½”ã«ã¾ã¨ã‚ãŸæ–‡ç« ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚
- JSONä»¥å¤–ã®ä½™è¨ˆãªæ–‡å­—åˆ—ï¼ˆä¾‹: \`\`\`json ... \`\`\`ï¼‰ã¯å‡ºåŠ›ã«å«ã‚ãªã„ã§ãã ã•ã„ã€‚
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾è¨­å®šã—ã¦ãã ã•ã„ã€‚
- WBSæ¡ˆã¯å¿…ãšç”Ÿæˆã—ã€LINEã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æç¤ºã—ã¾ã™ã€‚

# å‡ºåŠ›JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
{
  "properties": {
    "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹": "ğŸ“¥ æœªåˆ†é¡",
    "ç¨®åˆ¥": null,
    "å„ªå…ˆåº¦": null,
    "æœŸé™": null,
    "æˆæœç‰©": null,
    "ãƒ¬ãƒ™ãƒ«": null,
    "æ¡ˆä»¶": null,
    "æ‹…å½“è€…": null
  },
  "pageContent": "WBSã‚„ãƒ¡ãƒ¢ã®å†…å®¹ã‚’Markdownå½¢å¼ã®æ–‡å­—åˆ—ã§è¨˜è¿°",
  "wbsProposal": "LINEã§æç¤ºã™ã‚‹WBSæ¡ˆã®æ–‡å­—åˆ—"
}

# å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®é¸æŠè‚¢

## ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå¿…ãšã€ŒğŸ“¥ æœªåˆ†é¡ã€ã‚’è¨­å®šï¼‰
- "ğŸ“¥ æœªåˆ†é¡" â† å¿…ãšã“ã‚Œã‚’è¨­å®š

## ç¨®åˆ¥ï¼ˆæ¥­å‹™ã®æ€§è³ªï¼‰
- "ğŸ“‹ ä¼ç”»ãƒ»æˆ¦ç•¥": å°†æ¥ã®æ–¹å‘æ€§ã‚’æ±ºã‚ã‚‹ã€è¨ˆç”»ã‚’ç«‹ã¦ã‚‹æ¥­å‹™
- "ğŸ¨ åˆ¶ä½œãƒ»é–‹ç™º": å…·ä½“çš„ãªæˆæœç‰©ãƒ»ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œã‚‹æ¥­å‹™
- "ğŸš€ å®Ÿè¡Œãƒ»é‹ç”¨": æ–½ç­–å®Ÿè¡Œã€æ—¥å¸¸æ¥­å‹™ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- "ğŸ‘¥ ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ": äººãƒ»ãƒãƒ¼ãƒ ãƒ»ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†
- "ğŸ“Š åˆ†æãƒ»æ”¹å–„": ãƒ‡ãƒ¼ã‚¿åˆ†æã€æŒ¯ã‚Šè¿”ã‚Šã€æ”¹å–„æ¤œè¨
- "ğŸ¤ ãã®ä»–ãƒ»é›‘å‹™": ä¸Šè¨˜ã«å½“ã¦ã¯ã¾ã‚‰ãªã„æ¥­å‹™

## å„ªå…ˆåº¦
- "ğŸ”¥ç·Šæ€¥": ä»Šã™ãã‚„ã‚‹å¿…è¦ãŒã‚ã‚‹
- "â­ï¸é‡è¦": é‡è¦ã ãŒå°‘ã—æ™‚é–“ã«ä½™è£•ãŒã‚ã‚‹
- "ğŸ“…æ™®é€š": é€šå¸¸ã®æ¥­å‹™
- "ğŸ’­ã‚¢ã‚¤ãƒ‡ã‚¢": å°†æ¥çš„ã«æ¤œè¨ã—ãŸã„ã‚¢ã‚¤ãƒ‡ã‚¢

## æˆæœç‰©ï¼ˆæœ€çµ‚ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆï¼‰
- "ğŸ“Š è³‡æ–™ãƒ»ä¼ç”»æ›¸": æˆ¦ç•¥æ›¸ã€ä¼ç”»æ›¸ã€ææ¡ˆæ›¸ã€è¨ˆç”»æ›¸
- "ğŸ¨ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„": LPã€å‹•ç”»ã€è¨˜äº‹ã€SNSæŠ•ç¨¿ã€ãƒ¡ãƒ«ãƒã‚¬
- "ğŸ“ˆ ãƒ¬ãƒãƒ¼ãƒˆ": åˆ†æçµæœã€åŠ¹æœæ¸¬å®šã€æ¥­ç¸¾å ±å‘Š
- "âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ ãƒ»ãƒ„ãƒ¼ãƒ«": Webã‚µã‚¤ãƒˆã€ã‚¢ãƒ—ãƒªã€æ¥­å‹™ãƒ„ãƒ¼ãƒ«
- "ğŸ“‹ ãƒ«ãƒ¼ãƒ«ãƒ»ä»•çµ„ã¿": æ¥­å‹™ãƒ•ãƒ­ãƒ¼ã€ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã€åˆ¶åº¦è¨­è¨ˆ
- "ğŸ¯ ãã®ä»–": ä¸Šè¨˜ã«å½“ã¦ã¯ã¾ã‚‰ãªã„æˆæœç‰©

## ãƒ¬ãƒ™ãƒ«ï¼ˆè¦æ¨¡ï¼‰
- "ğŸ¢ æˆ¦ç•¥ãƒ¬ãƒ™ãƒ«": 3ãƒ¶æœˆä»¥ä¸Šã€äº‹æ¥­ãƒ»çµ„ç¹”å…¨ä½“ã«å¤§ããªå½±éŸ¿
- "ğŸ“‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ": 1-3ãƒ¶æœˆã€è¤‡æ•°äººã®ãƒãƒ¼ãƒ 
- "âœ… ã‚¿ã‚¹ã‚¯": 1-4é€±é–“ã€å€‹äººã¾ãŸã¯å°‘æ•°ã§å®Œçµ
- "âš¡ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³": 1æ—¥-1é€±é–“ã€ã™ãã§ãã‚‹ä½œæ¥­
- "ğŸ’­ ãƒ¡ãƒ¢": æ€è€ƒæ•´ç†ã€ã‚¢ã‚¤ãƒ‡ã‚¢å‡ºã—

## æ¡ˆä»¶ï¼ˆé–¢é€£ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰
- "ONEãƒãƒ¼ã‚±/ãƒãƒ¼ã‚±ãƒ©ãƒœ": ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°é–¢é€£
- "ã‚‹ã„/redeal": å–¶æ¥­ãƒ»ã‚»ãƒ¼ãƒ«ã‚¹é–¢é€£
- "ã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ†": ã‚¹ãƒãƒ¼ãƒ„é–¢é€£äº‹æ¥­
- "æ± è¢‹ã‚µãƒ³ã‚·ãƒ£ã‚¤ãƒ³ç¾å®¹": ç¾å®¹äº‹æ¥­é–¢é€£
- "femuse": å¥³æ€§å‘ã‘ã‚µãƒ¼ãƒ“ã‚¹
- "ãã®ä»–": ä¸Šè¨˜ã«å½“ã¦ã¯ã¾ã‚‰ãªã„æ¡ˆä»¶

## æ‹…å½“è€…
- "è‡ªåˆ†": åŸºæœ¬çš„ã«è‡ªåˆ†ãŒæ‹…å½“

# åˆ¤æ–­åŸºæº–

## ç¨®åˆ¥ã®åˆ¤æ–­
- ã€Œè€ƒãˆã‚‹ã€ã€Œè¨ˆç”»ã™ã‚‹ã€ã€Œæˆ¦ç•¥ã‚’ç·´ã‚‹ã€â†’ ä¼ç”»ãƒ»æˆ¦ç•¥
- ã€Œä½œã‚‹ã€ã€Œé–‹ç™ºã™ã‚‹ã€ã€Œåˆ¶ä½œã™ã‚‹ã€â†’ åˆ¶ä½œãƒ»é–‹ç™º
- ã€Œå®Ÿè¡Œã™ã‚‹ã€ã€Œé‹ç”¨ã™ã‚‹ã€ã€Œå‹•ã‹ã™ã€â†’ å®Ÿè¡Œãƒ»é‹ç”¨
- ã€Œç®¡ç†ã™ã‚‹ã€ã€Œè‚²æˆã™ã‚‹ã€ã€Œçµ„ç¹”ã‚’å‹•ã‹ã™ã€â†’ ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ
- ã€Œåˆ†æã™ã‚‹ã€ã€ŒæŒ¯ã‚Šè¿”ã‚‹ã€ã€Œæ”¹å–„ã™ã‚‹ã€â†’ åˆ†æãƒ»æ”¹å–„
- ã©ã‚Œã«ã‚‚å½“ã¦ã¯ã¾ã‚‰ãªã„ â†’ ãã®ä»–ãƒ»é›‘å‹™

## ãƒ¬ãƒ™ãƒ«ã®åˆ¤æ–­
- æœŸé–“ã¨é–¢ä¿‚è€…æ•°ã§åˆ¤æ–­
- è¿·ã£ãŸã‚‰å°ã•ã‚ã«åˆ†é¡ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆâ†’ã‚¿ã‚¹ã‚¯â†’ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

## æˆæœç‰©ã®åˆ¤æ–­
- ã€Œæœ€çµ‚çš„ã«ä½•ãŒã§ãã‚‹ã‹ã€ã§åˆ¤æ–­
- è¿·ã£ãŸã‚‰ã€Œãã®ä»–ã€

## æ¡ˆä»¶ã®åˆ¤æ–­
- ãƒ†ã‚­ã‚¹ãƒˆã«ç‰¹å®šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯è©²å½“ã™ã‚‹æ¡ˆä»¶ã‚’é¸æŠ
- ä¸æ˜ãªå ´åˆã¯ã€Œãã®ä»–ã€

# ä¾‹
ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: "æ–°å•†å“ã®ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã‚’æ¥æœˆã¾ã§ã«ç­–å®šã™ã‚‹"
â†’ ç¨®åˆ¥: "ä¼ç”»ãƒ»æˆ¦ç•¥", ãƒ¬ãƒ™ãƒ«: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ", æˆæœç‰©: "è³‡æ–™ãƒ»ä¼ç”»æ›¸", æ¡ˆä»¶: "ONEãƒãƒ¼ã‚±/ãƒãƒ¼ã‚±ãƒ©ãƒœ"

ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: "éƒ¨ä¸‹ã®1on1ã‚’æ¥é€±å®Ÿæ–½"  
â†’ ç¨®åˆ¥: "ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ", ãƒ¬ãƒ™ãƒ«: "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³", æˆæœç‰©: "ãã®ä»–", æ¡ˆä»¶: "ãã®ä»–"

ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: "ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®LPã‚’åˆ¶ä½œ"
â†’ ç¨®åˆ¥: "åˆ¶ä½œãƒ»é–‹ç™º", ãƒ¬ãƒ™ãƒ«: "ã‚¿ã‚¹ã‚¯", æˆæœç‰©: "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„", æ¡ˆä»¶: "ONEãƒãƒ¼ã‚±/ãƒãƒ¼ã‚±ãƒ©ãƒœ"

ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: "æ± è¢‹ã®ç¾å®¹ã‚µãƒ­ãƒ³ã®é›†å®¢åˆ†æ"
â†’ ç¨®åˆ¥: "åˆ†æãƒ»æ”¹å–„", ãƒ¬ãƒ™ãƒ«: "ã‚¿ã‚¹ã‚¯", æˆæœç‰©: "ãƒ¬ãƒãƒ¼ãƒˆ", æ¡ˆä»¶: "æ± è¢‹ã‚µãƒ³ã‚·ãƒ£ã‚¤ãƒ³ç¾å®¹"

ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã€Œ${text}ã€ã‚’è§£æã—ã€ä¸Šè¨˜ã®å½¢å¼ã§JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
`;

      // æœ€æ–°ã®Gemini 1.5 Flashãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
      const model = this.gemini.getGenerativeModel({ 
        model: "gemini-1.5-flash",
        generationConfig: {
          temperature: 0.7,
          topK: 40,
          topP: 0.95,
          maxOutputTokens: 1024,
        }
      });
      
      console.log('[GEMINI] Using model: gemini-1.5-flash');
      const result = await model.generateContent(systemPrompt);
      const response = await result.response;
      const jsonString = response.text();
      
      console.log('[GEMINI] Raw response:', jsonString);
      
      // JSONã®å‰å¾Œã«ã‚ã‚‹ä¸è¦ãªæ–‡å­—åˆ—ã‚’é™¤å»
      let cleanedJsonString = jsonString.trim();
      
      // ```json ``` ãªã©ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã‚’é™¤å»
      if (cleanedJsonString.startsWith('```json')) {
        cleanedJsonString = cleanedJsonString.replace(/^```json\s*/, '').replace(/\s*```$/, '');
      } else if (cleanedJsonString.startsWith('```')) {
        cleanedJsonString = cleanedJsonString.replace(/^```\s*/, '').replace(/\s*```$/, '');
      }
      
      const parsedResult = JSON.parse(cleanedJsonString);
      
      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’åˆ¥é€”è¨­å®š
      parsedResult.properties.Name = text;
      
      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¿…ãšã€ŒğŸ“¥ æœªåˆ†é¡ã€ã«è¨­å®š
      parsedResult.properties.ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ = "ğŸ“¥ æœªåˆ†é¡";

      console.log('[GEMINI] Analyzed data:', JSON.stringify(parsedResult, null, 2));
      return parsedResult;

    } catch (error) {
      console.error('[GEMINI] Error details:', error);
      
      // Geminiã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
      if (error.message.includes('GoogleGenerativeAI') || error.message.includes('404')) {
        console.log('[GEMINI] Using fallback analysis due to API error');
        return this.createFallbackAnalysis(text);
      }
      
      throw new Error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    }
  }

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ç°¡æ˜“è§£æ
  createFallbackAnalysis(text) {
    const analysis = {
      properties: {
        Name: text,
        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: "ğŸ“¥ æœªåˆ†é¡",
        ç¨®åˆ¥: null,
        å„ªå…ˆåº¦: null,
        æœŸé™: null,
        æˆæœç‰©: null,
        ãƒ¬ãƒ™ãƒ«: null,
        æ¡ˆä»¶: null,
        æ‹…å½“è€…: null
      },
      pageContent: `## æ¦‚è¦\n${text}\n\n## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\n- è©³ç´°ã‚’æ¤œè¨ã™ã‚‹\n- å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªã™ã‚‹\n- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç«‹ã¦ã‚‹`,
      wbsProposal: `ğŸ“‹ ${text}ã®WBSæ¡ˆ:\n\n1. è¦ä»¶æ•´ç†ãƒ»åˆ†æ\n2. è¨ˆç”»ç­–å®š\n3. å®Ÿè¡Œæº–å‚™\n4. å®Ÿæ–½ãƒ»é€²æ—ç®¡ç†\n5. å®Œäº†ãƒ»æŒ¯ã‚Šè¿”ã‚Š`
    };
    
    console.log('[GEMINI] Fallback analysis created:', JSON.stringify(analysis, null, 2));
    return analysis;
  }

  validateProjectData(data) {
    if (!data.properties) {
        throw new Error('"properties" field is missing from Gemini response.');
    }
    const requiredFields = [
      'Name',
      'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
      'ç¨®åˆ¥',
      'å„ªå…ˆåº¦',
      'æˆæœç‰©',
      'ãƒ¬ãƒ™ãƒ«'
    ];

    const missingFields = requiredFields.filter(field => !data.properties[field]);
    if (missingFields.length > 0) {
      throw new Error(`å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã¾ã™: ${missingFields.join(', ')}`);
    }
    
    if (typeof data.pageContent !== 'string') {
        throw new Error('pageContent must be a string.');
    }

    return true;
  }
}

module.exports = new ProjectAnalyzer();
