const { OpenAI } = require('openai');
require('dotenv').config();

// OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// å…±é€šã®è¨­å®š
const config = {
  model: 'gpt-3.5-turbo',
  temperature: 0.7,
  max_tokens: 1000
};

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±æŠ½å‡ºç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
const projectPrompt = `ã‚ãªãŸã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚
ä»¥ä¸‹ã®æ¡ä»¶ã«å¾“ã£ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è§£æžãƒ»æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

æ¡ä»¶ï¼š
1. ç¾åœ¨ã®æ—¥ä»˜ã‚’è€ƒæ…®ã—ã¦å‡¦ç†ã™ã‚‹
2. å„é …ç›®ã¯å˜ä¸€ã®å€¤ã‚’é¸æŠžã™ã‚‹ï¼ˆé…åˆ—ã§ã¯ãªãï¼‰
3. ä¸æ˜Žãªæƒ…å ±ã¯é©åˆ‡ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã™ã‚‹

å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆï¼š
ã€Œ${userInput}ã€

å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰ï¼š
{
  "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå": "æ–‡å­—åˆ—ï¼ˆå…·ä½“çš„ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼‰",
  "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹": "æœªç€æ‰‹",
  "ç¨®åˆ¥": "ä¼ç”»",
  "å„ªå…ˆåº¦": "â­é‡è¦",
  "æœŸé™": "YYYY-MM-DD",
  "ãƒ•ã‚§ãƒ¼ã‚º": "ä¼ç”»",
  "æ‹…å½“è€…": "è‡ªåˆ†",
  "æˆæžœç‰©": "ä¼ç”»æ›¸",
  "ãƒ¬ãƒ™ãƒ«": "ðŸŽ¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ"
}

â€»å„é …ç›®ã®é¸æŠžè‚¢ï¼š
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: "æœªç€æ‰‹", "é€²è¡Œä¸­", "ç¢ºèªå¾…ã¡", "å®Œäº†", "ä¿ç•™", "ðŸ—‘ï¸ã‚´ãƒŸç®±"
- ç¨®åˆ¥: "ä¼ç”»", "åˆ¶ä½œ", "å®Ÿè¡Œ", "åˆ†æž", "ðŸ“ãƒ¡ãƒ¢"
- å„ªå…ˆåº¦: "ðŸ”¥ç·Šæ€¥", "â­é‡è¦", "ðŸ“…æ™®é€š", "ðŸ’­ã‚¢ã‚¤ãƒ‡ã‚¢"
- ãƒ•ã‚§ãƒ¼ã‚º: "ã‚¢ã‚¤ãƒ‡ã‚¢", "ä¼ç”»", "å®Ÿè¡Œ", "åˆ†æž", "æ”¹å–„ãƒ»é‹ç”¨"
- æ‹…å½“è€…: "è‡ªåˆ†", "ãƒãƒ¼ãƒ ", "å¤–éƒ¨", "æœªå®š"
- æˆæžœç‰©: "è³‡æ–™", "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„", "ãƒ‡ãƒ¼ã‚¿", "ä¼ç”»æ›¸", "ãƒ¬ãƒãƒ¼ãƒˆ", "ãã®ä»–"
- ãƒ¬ãƒ™ãƒ«: "ðŸŽ¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ", "ðŸ“‹ã‚¿ã‚¹ã‚¯", "âš¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"`;

// WBSç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
const wbsPrompt = `ã‚ãªãŸã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚
ä»¥ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã™ã‚‹å…·ä½“çš„ãªWBSã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ï¼š
${projectInfo}

ä»¥ä¸‹ã®æ¡ä»¶ã§WBSã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š
1. ã‚¿ã‚¹ã‚¯ã¯å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã¾ã§åˆ†è§£
2. å„ã‚¿ã‚¹ã‚¯ã«æƒ³å®šæœŸé–“ã‚’è¨­å®š
3. ã‚¿ã‚¹ã‚¯ã®é †åºé–¢ä¿‚ã‚’è€ƒæ…®
4. ãƒ¬ãƒ™ãƒ«ã¯3æ®µéšŽï¼ˆðŸŽ¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ/ðŸ“‹ã‚¿ã‚¹ã‚¯/âš¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰ï¼š
{
  "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ": {
    "åç§°": "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå",
    "ãƒ¬ãƒ™ãƒ«": "ðŸŽ¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ",
    "æƒ³å®šæœŸé–“": "æ—¥æ•°",
    "ã‚µãƒ–ã‚¿ã‚¹ã‚¯": [
      {
        "åç§°": "ã‚¿ã‚¹ã‚¯å",
        "ãƒ¬ãƒ™ãƒ«": "ðŸ“‹ã‚¿ã‚¹ã‚¯ or âš¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³",
        "æƒ³å®šæœŸé–“": "Xæ—¥",
        "é–‹å§‹ç›®å®‰": "YYYY-MM-DD",
        "çµ‚äº†ç›®å®‰": "YYYY-MM-DD",
        "æ‹…å½“": "è‡ªåˆ† | ãƒãƒ¼ãƒ  | å¤–éƒ¨ | æœªå®š",
        "æˆæžœç‰©": "è³‡æ–™ | ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ | ãƒ‡ãƒ¼ã‚¿ | ä¼ç”»æ›¸ | ãƒ¬ãƒãƒ¼ãƒˆ | ãã®ä»–"
      }
    ]
  }
}`;

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®è§£æž
const analyzeProject = async (text) => {
  try {
    const completion = await openai.chat.completions.create({
      ...config,
      messages: [
        { role: 'system', content: projectPrompt },
        { role: 'user', content: text }
      ]
    });

    return JSON.parse(completion.choices[0].message.content);
  } catch (error) {
    console.error('Error analyzing project:', error);
    throw error;
  }
};

// WBSã®ç”Ÿæˆ
const generateWBS = async (projectInfo) => {
  try {
    const completion = await openai.chat.completions.create({
      ...config,
      messages: [
        { role: 'system', content: wbsPrompt },
        { role: 'user', content: JSON.stringify(projectInfo) }
      ]
    });

    return JSON.parse(completion.choices[0].message.content);
  } catch (error) {
    console.error('Error generating WBS:', error);
    throw error;
  }
};

module.exports = {
  analyzeProject,
  generateWBS
}; 